#!/bin/bash

DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )

dockerInstalled=$(which docker)
if [[ $dockerInstalled == "" ]]; then
    sudo apt-get update
    sudo apt-get upgrade -y
    sudo apt-get install -y curl apt-transport-https ca-certificates software-properties-common
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
    sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
    sudo apt-get update
    sudo apt-get install -y docker-ce
    # to avoid typing sudo while using docker
    sudo usermod -aG docker ${USER}
fi

# what if VBox version is not the same?
VBoxInstalled=$(which virtualbox)
if [[ $VBoxInstalled == "" ]]; then
    sudo apt-get update; sudo apt-get install -y linux-headers-generic linux-headers-$(uname -r) curl libcurl4 libvpx5 procps dbus
    set -x && sudo mkdir -p /etc/xdg/QtProject
    sudo apt-get update; sudo apt-get install -y ca-certificates gnupg 
    sudo curl -sSL https://www.virtualbox.org/download/oracle_vbox_2016.asc | apt-key add -
    sudo echo "deb http://download.virtualbox.org/virtualbox/debian buster contrib" >> /etc/apt/sources.list.d/virtualbox.list
    sudo apt-get update; sudo apt-get install -y virtualbox-5.2 --no-install-recommends
fi

tcpdumpInstalled=$(dpkg -l | grep tcpdump)
if [[ $tcpdumpInstalled == "" ]]; then
    sudo apt-get install -y tcpdump
fi

apparmorInstalled=$(dpkg -l | grep apparmor-utils)
if [[ $apparmorInstalled == "" ]]; then
    sudo apt-get install -y apparmor-utils
    sudo setcap cap_net_raw,cap_net_admin=eip /usr/sbin/tcpdump
fi

apparmorResult=$(sudo aa-status | grep /usr/sbin/tcpdump)
if [[ $apparmorResult == *"/usr/sbin/tcpdump"* ]]; then
    sudo aa-disable /usr/sbin/tcpdump
fi

# If you want to use mongodb you have to install mongo on host because the server side is on host
mongodbInstalled=$(which mongo)
if [[ $mongodbInstalled == "" ]]; then
    wget -qO - https://www.mongodb.org/static/pgp/server-4.2.asc | sudo apt-key add -
    echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu bionic/mongodb-org/4.2 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-4.2.list
    sudo apt-get update
    sudo apt-get install -y mongodb-org
fi

mongo_version=$(mongo --version | head -n 1 | cut -d 'v' -f 3 | cut -d '.' -f 1,2)
sed "s/__mongodb-version__/$mongo_version/g" "$DIR/Dockerfile_template" > "$DIR/Dockerfile"

docker build "$DIR" -t cuckoodockerv3


