#!/bin/bash

cuckooContainer="cuckooWeb"
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

if netstat -ntlp | grep --quiet 8000; then
    echo "There is a process using the port 8000, web interface cannot start"
    exit 1
#    echo "killing process using port 8000"
#    sudo fuser -k 8000/tcp
fi

"$DIR/start_container.sh" "$cuckooContainer" "cuckoo_web"

#docker exec $cuckooContainer elasticsearch
docker exec $cuckooContainer cuckoo >> "$DIR/../results/web_cuckoo.log" 2>&1 &
docker exec $cuckooContainer cuckoo -d web >> "$DIR/../results/web_interface.log" 2>&1 &
sleep 3
has_error=$(tail -n 3 "$DIR/../results/web_cuckoo.log" | grep -E "ERROR|Error")
if [[ $has_error == "" ]]; then
    web_fail=$(tail -n 2 "$DIR/../results/web_interface.log" | grep -E "up-and-running|Error")
    if [[ $web_fail == "" ]]; then
        echo -e "\033[0;32mSuccess\033[0m: You can now access cuckoo at the address localhost:8000"
    else
        echo -e "\033[0;31mFailure\033[0m: Error with the web interface:"
        echo -e "$web_fail"
    fi
else
    echo -e "\033[0;31mFailure\033[0m: error encontered with command cuckoo:"
    echo -e "$has_error"
fi

