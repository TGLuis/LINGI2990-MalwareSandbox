#!/bin/bash

# -v /dev/vboxdrvu:/dev/vboxdrvu
# -v /dev/vboxnetctl:/dev/vboxnetctl

if [ ! $1 ]; then
    cuckooContainer="myCuckooContainer"
else
    cuckooContainer="$1"
fi
if [ ! $2 ]; then
    CWD="cuckoo_default"
else
    CWD="$2"
fi

sharedFolder="shared_with_docker"

exists=$(docker ps -a --filter "name=$cuckooContainer" | grep $cuckooContainer)
if [[ $exists == "" ]]; then
    
    path="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

    docker create --name $cuckooContainer -i \
        -v "$path/../$sharedFolder/$CWD":/home/cuckoo/.cuckoo \
        -v "$path/../$sharedFolder/malwares":/home/cuckoo/malwares \
        -v "$path/../$sharedFolder/vms":/home/cuckoo/vms \
        -v "$path/../$sharedFolder/monitor":/home/cuckoo/mymonitor \
        -v "$path/../$sharedFolder/others":/home/cuckoo/others \
        -v /dev/vboxdrv:/dev/vboxdrv  \
        --network=host \
        --privileged \
        cuckoodockerv3:latest

    docker start $cuckooContainer
    docker exec -it $cuckooContainer ln -sd "/home/cuckoo/.cuckoo" "/root/.cuckoo"
    # import community and create symbolic link if not done (necessary for hooks)
    docker exec -it $cuckooContainer cuckoo community --file master.tar.gz

    # install the extension pack and import the vm
    version=$(docker exec -it $cuckooContainer dpkg -s virtualbox-5.2 | grep '^Version: ' | sed -e 's/Version: \([0-9\.]*\)\-.*/\1/')
    docker exec -it $cuckooContainer VBoxManage extpack install /home/cuckoo/Oracle_VM_VirtualBox_Extension_Pack-$version.vbox-extpack --accept-license=56be48f923303c8cababb0bb4c478284b688ed23f16d775d729b89a2e8e5f9eb
    docker exec -it $cuckooContainer VBoxManage import /home/cuckoo/vms/cuckoo1.ova
    sleep 1s

    # make snapshot of the vm
    docker exec -it $cuckooContainer VBoxManage startvm cuckoo1 --type headless
    docker exec -it $cuckooContainer VBoxManage snapshot cuckoo1 take snapshot1
    docker exec -it $cuckooContainer VBoxManage controlvm cuckoo1 poweroff soft

else
    echo "Container already created"
fi

